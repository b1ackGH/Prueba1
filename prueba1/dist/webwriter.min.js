!function(){var t=/Mac/.test(navigator.platform),e=/Win/.test(navigator.platform),i={on:function(t,e,i,n){return t.addEventListener(e,i,!1),n?function(){t.removeEventListener(e,i,!1)}:void 0},off:function(t,e,i){t.removeEventListener(e,i,!1)},preventDefault:function(t){t.preventDefault()},stopPropagation:function(t){t.stopPropagation()},stop:function(t){i.preventDefault(t),i.stopPropagation(t)}};String.prototype.splice=function(t,e,i){return e=+e||0,i=i||"",this.slice(0,t)+i+this.slice(t+e)};var n=function(t,e){for(var i in e)t[i]=e[i];return t},o={copy:function(t){return{line:t.line,ch:t.ch,x:t.x,y:t.y}},equal:function(t,e){return t.line===e.line&&t.ch===e.ch},line:function(t,e){return t.line===e.line},less:function(t,e){return t.line<e.line||t.line==e.line&&t.ch<e.ch},isWordChar:function(t){return/\w/.test(t)||t.toUpperCase()!=t.toLowerCase()}},s=function(t,e){this.options={localStorage:"content",max_line:64,padding_length:6,smartTypingPairs:!0,smartNewline:!0},n(this.options,e),this.tag_container="p",this.mark_container="mark",this.line_height=32,this.em_width=13,this.width=832,this.padding=156,this.tab_width=64,this.focused=null,this.lastDoubleClick=null,this.lastClick=null,this.focusmode=null,this.shiftSelecting=null,this.textSelected=null,this.textPasted=null,this.previousSelection=null,this.charCode=null,this.inputValue=null,this.from=this.to={line:null,ch:null,x:null,y:null},this.inverted=null,this.create(),this.undomanager=new c,this.hideCursor(),this.setLayout(),this.setTab(),this.addLines(t),this.addEvents()};n(s.prototype,{create:function(){var t='<section class="editor"><header></header><section class="view"><div class="wrapper"><section class="body"><aside class="measure"></aside><aside class="selection"><mark></mark><mark></mark><mark></mark></aside><article class="content"></article><div class="cursor"></div><textarea class="input" autocorrect="off" autocapitalize="off" wrap="off"></textarea></section></div></section><footer></footer></section>',e=document.createElement("div");e.innerHTML=t;var i=e.firstChild,n=i.firstChild,o=i.lastChild,s=n.nextSibling,l=s.firstChild,r=l.firstChild,h=r.firstChild,a=h.nextSibling,c=a.firstChild,d=c.nextSibling,u=a.lastChild,p=a.nextSibling,f=p.nextSibling,g=f.nextSibling;this.editor=i,this.element={header:n,footer:o,view:s,wrapper:l,body:r,measure:h,selection:a,selectionTop:c,selectionMiddle:d,selectionBottom:u,content:p,cursor:f,input:g},document.body.appendChild(this.editor)},setLayout:function(t){var e=this.options,i=this.element.measure,n=this.element.wrapper,o=this.element.content,s=this.tag_container;i.innerHTML="<"+s+">m</"+s+">";var l=i.firstChild;e.max_line=t=t||e.max_line,this.width=l.offsetWidth*t,this.line_height=l.offsetHeight,this.em_width=l.offsetWidth,this.padding=e.padding_length*this.em_width,this.padding_width=2*this.padding,n.style.width=this.width+this.padding_width+"px",n.style.padding=this.line_height+"px 0",o.style.padding="0 "+this.padding+"px"},setTab:function(){var t=this.element.measure,e=this.tag_container;t.innerHTML="<"+e+'><span class="tab">&Tab;</span></'+e+">";var i=t.firstChild;this.tab_width=i.offsetWidth}}),n(s.prototype,{addEvents:function(){var t=this.element,e=t.view,n=t.input;i.on(e,"mousedown",this.onMouseDown.bind(this)),i.on(e,"selectstart",i.preventDefault),i.on(n,"keyup",this.onKeyUp.bind(this)),i.on(n,"input",this.onInput.bind(this)),i.on(n,"keydown",this.onKeyDown.bind(this)),i.on(n,"focus",this.onFocus.bind(this)),i.on(n,"blur",this.onBlur.bind(this)),i.on(n,"paste",this.onPaste.bind(this))},onFocus:function(){this.focused||(this.focused=!0,this.editor.classList.add("focused")),this.blinkCursor()},onBlur:function(){this.focused&&(this.focused=!1,this.editor.classList.remove("focused")),this.save(),this.hideCursor();var t=this;setTimeout(function(){t.focused||t.setShift()},150)},onMouseDown:function(t){var e,n,s=this,l=this.element.view.getBoundingClientRect(),r=this.from.line,h=t.y>=l.bottom-10?t.y-10:t.y,a=this.getPosition(t.x,h);if(this.setShift(t.shiftKey),t.target.classList.contains("todo"))return this.toggleToDo(a,a),i.preventDefault(t);this.focused||this.onFocus();var c=+new Date;if(this.lastDoubleClick&&this.lastDoubleClick.time>c-400&&o.equal(this.lastDoubleClick.position,a))return i.preventDefault(t),this.selectLine(a);if(this.lastClick&&this.lastClick.time>c-400&&o.equal(this.lastClick.position,a))return this.lastDoubleClick={time:c,position:a},i.preventDefault(t),this.selectWordAt(a);this.lastClick={time:c,position:a},i.preventDefault(t),this.updateCursor(a,a),e=a,a=this.shiftSelecting||a,this.previousSelection=null,this.updateSelection(a,e);var d=function(t){var i=e,o=s.element.view;t.y<=l.top+10?0!==o.scrollTop&&(o.scrollTop-=s.line_height,n=setTimeout(function(){d(t)},150),i=0===o.scrollTop?s.getPositionFromChar(1,0):s.getPosition(t.x,l.top+10)):t.y>=l.bottom-10?o.scrollHeight-o.offsetHeight!==o.scrollTop&&(o.scrollTop+=s.line_height,i=s.getPosition(t.x,l.bottom-10),n=setTimeout(function(){d(t)},150)):t.x>=0&&t.x<=window.innerWidth&&(i=s.getPositionFromEvent(t)),e=i,s.updateSelection(a,i)},u=i.on(document.body,"mousemove",function(t){clearTimeout(n),i.preventDefault(t),d(t)},!0),p=i.on(window,"mouseup",function(t){if(clearTimeout(n),i.preventDefault(t),s.focusmode){s.getLine(r).classList.remove("active"),s.editor.classList.add("focusmode");var e=i.on(s.element.view,"mousewheel",function(){s.onMouseWheel(),e()},!0)}s.updateView(s.from,s.to),s.focusInput(),u(),p()},!0)},onMouseWheel:function(){this.getLine(this.selectionStart().line).classList.remove("active"),this.editor.classList.remove("focusmode")},onKeyDown:function(e){this.focused||this.focusInput();var n,o,s=l.keyNames[e.keyCode];if(this.setShift(16==e.keyCode||e.shiftKey),null===s||e.altGraphKey)return null;if(e.altKey&&(s="alt+"+s),e.ctrlKey&&(s=(t?"ctrl":"super")+"+"+s),e.metaKey&&(s="super+"+s),e.shiftKey&&(n=l.bind["shift+"+s])?o=!0:n=l.bind[s],"string"==typeof n&&(n=this[n].bind(this)),!n)return!1;if(o){var r=this.shiftSelecting;this.shiftSelecting=null,n(),this.shiftSelecting=r}else n();i.preventDefault(e)},onInput:function(){var t=this;setTimeout(function(){t.add()},5)},onKeyUp:function(t){16==t.keyCode?this.shiftSelecting=null:this.textPasted=null},onPaste:function(){this.textPasted=!0}});var l={bind:{left:"goCharLeft",right:"goCharRight",up:"goLineUp",down:"goLineDown",end:"goLineEnd",home:"goDocStart",pageUp:"goPageUp",pageDown:"goPageDown","delete":"delCharRight",backspace:"delCharLeft",tab:"indentMore","shift+tab":"indentLess",enter:"newlineAndIndent",insert:"toggleOverwrite","super+d":"toggleFocusMode","super+a":"selectAll","super+z":"undo","shift+super+z":"redo","super+y":"redo","super+up":"goDocStart","super+end":"goDocEnd","super+down":"goDocEnd","alt+left":"goWordLeft","alt+right":"goWordRight","super+left":"goLineStart","super+right":"goLineEnd","alt+up":"goLineStart","alt+down":"goLineEnd","alt+backspace":"delWordLeft","ctrl+alt+backspace":"delWordRight","super+backspace":"deleteLine","alt+delete":"delWordRight","super+s":"save","super+g":"findNext","shift+super+g":"findPrev","super+alt+f":"replace","shift+super+alt+f":"replaceAll","super+f":"toggleFullScreen","super+b":"makeStrong","super+i":"makeEmphasis","super+u":"makeDelete","super+l":"toggleToDo","Ctrl-F":"goCharRight","Ctrl-B":"goCharLeft","Ctrl-P":"goLineUp","Ctrl-N":"goLineDown","Alt-F":"goWordRight","Alt-B":"goWordLeft","Ctrl-A":"goLineStart","Ctrl-E":"goLineEnd","Ctrl-V":"goPageUp","Shift-Ctrl-V":"goPageDown","Ctrl-D":"delCharRight","Ctrl-H":"delCharLeft","Alt-D":"delWordRight","Alt-Backspace":"delWordLeft","Ctrl-K":"killLine","Ctrl-T":"transposeChars"},windows:{"super+left":"goWordLeft","super+right":"goWordRight","alt+left":"goLineStart","alt+right":"goLineEnd","super+home":"goDocStart","alt+up":"goDocStart","super+delete":"delWordRight","shift+super+f":"replace","shift+super+r":"replaceAll"},smartTypingPairs:{'"':'"',"(":")","{":"}","[":"]","<":">","`":"`"}};if(e)for(var r in l.windows)l.bind[r]=l.windows[r];var h={3:"enter",8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capsLock",27:"esc",32:"space",33:"pageUp",34:"pageDown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",44:"printScrn",45:"insert",46:"delete",59:";",91:"mod",92:"mod",93:"mod",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'",63276:"pageUp",63277:"pageDown",63275:"end",63273:"home",63234:"left",63232:"up",63235:"right",63233:"down",63302:"insert",63272:"delete"};l.keyNames=h,function(){for(var t=0;10>t;t++)h[t+48]=String(t);for(t=65;90>=t;t++)h[t]=String.fromCharCode(t).toLowerCase();for(t=1;12>=t;t++)h[t+111]=h[t+63235]="f"+t}(),n(s.prototype,{addLines:function(t){t=this.parserLines(t),this.element.content.appendChild(t)},replaceLines:function(t,e,i){var n=this.element.content;if(i=this.parserLines(i),t===e)n.replaceChild(i,this.getLine(t));else{for(var o,s=this.getLine(t),l=e-t+1;l--;)o=s.nextSibling,n.removeChild(s),s=o;s?n.insertBefore(i,s):n.appendChild(i)}},updateView:function(t,e){if(this.focusmode){var i=this.getLine(this.from.line);i&&i.classList.remove("active"),this.getLine(t.line).classList.add("active")}this.updateSelection(t,e),this.updateCursor(t,e),this.updateInput()},getSize:function(){return this.element.content.childNodes.length},getLine:function(t){return this.element.content.childNodes[t-1]},getText:function(t,e){var i,n,o;if(i=this.getLine(t),n=[i.textContent],t!=e)for(o=t;e>o;)i=i.nextSibling,n.push(i.textContent),++o;return n.join("\n")},getContent:function(t,e){var i,n,s,l,r=0;if(i=this.getLine(t.line),n=[i.textContent],!o.line(t,e))for(s=t.line;s<e.line;)r+=i.textContent.length,i=i.nextSibling,n.push(i.textContent),++s;return l={textContent:n.join("\n"),selectionStart:t.ch,selectionEnd:r+e.ch+n.length-1},l.chunk=[l.textContent.slice(0,l.selectionStart),l.textContent.slice(l.selectionStart,l.selectionEnd),l.textContent.slice(l.selectionEnd)],l},getPositionFromPoint:function(t,e){var i=this.element,n=i.wrapper,o=i.view;return t+=n.getBoundingClientRect().left,e+=o.getBoundingClientRect().top+8,e-=o.scrollTop-parseInt(n.style.paddingTop),this.getPosition(t,e)},getPositionFromEvent:function(t){return this.getPosition(t.x,t.y)},getPositionFromChar:function(t,e){var i,n,o,s,l,r,h;for(i=this.getLine(t),n=document.createTreeWalker(i,NodeFilter.SHOW_TEXT,null,!1),o=e;n.nextNode()&&(i=n.currentNode,!(i.textContent.length>=o));)o-=i.textContent.length;s=document.createRange(),s.selectNodeContents(i),s.setStart(s.startContainer,o),s.setEnd(s.endContainer,o);var a=s.getClientRects();l=a.length>1?a[1]:a[0];var c=this.element,d=c.wrapper,u=c.content,p=this.line_height;return r=l.left,h=Math.floor((l.top-u.getBoundingClientRect().top)/p),{line:t,ch:e,x:r-d.getBoundingClientRect().left,y:h*p}},getPosition:function(t,e){var i=document.caretRangeFromPoint(t,e);i.expand("character");for(var n=i.startContainer,o=i.startOffset,s=this.tag_container;n&&n.localName!=s;)n.previousSibling?(o+=n.previousSibling.textContent.length,n=n.previousSibling):n=n.parentNode;for(var l=0;n;)n=n.previousSibling,++l;var r,h=i.getClientRects();r=h.length>1?h[e>h[0].bottom?1:0]:h[0];var a=this.element,c=a.wrapper,d=a.content,u=this.line_height;return t=r.left,e=Math.floor((r.top-d.getBoundingClientRect().top)/u),{line:l,ch:o,x:t-c.getBoundingClientRect().left,y:e*u}},findWord:function(t){for(var e=this.getLine(t.line).textContent,i=t.ch,n=t.ch;i>0&&o.isWordChar(e.charAt(i-1));)--i;for(;n<e.length&&o.isWordChar(e.charAt(n));)++n;var s=this.getPositionFromChar(t.line,i),l=this.getPositionFromChar(t.line,n);return{from:s,to:l}},findPoint:function(t,e,i){function n(){for(var t=h+e,i=0>e?0:c;t!=i;t+=e)return h=t,l=r.getLine(h),!0}function s(t){if(a==(0>e?0:l.textContent.length)){if(t||!n())return!1;a=0>e?l.textContent.length:0}else a+=e;return!0}var l,r=this,h=t.line,a=t.ch,c=this.getSize()+1;if(l=this.getLine(h),"char"==i)s();else if("column"==i)s(!0);else if("word"==i)for(var d=!1;!(0>e)||s();){if(o.isWordChar(l.textContent.charAt(a)))d=!0;else if(d){0>e&&(e=1,s());break}if(e>0&&!s())break}return this.getPositionFromChar(h,a,e)},moveHorizontalPoint:function(t,e){var i=this.from,n=this.to,s=n;s=this.shiftSelecting||o.equal(i,n)?this.findPoint(s,t,e):o.less(i,n)?0>t?i:n:0>t?n:i,this.updateView(this.shiftSelecting?this.from:s,s),this.previousSelection=null},moveVerticalPoint:function(t,e){var i=0,n=this.from,s=this.to,l=s;if("page"==e?i=scroller.clientHeight:"line"==e&&(i=this.line_height),this.shiftSelecting||o.equal(n,s)){null!==this.previousSelection&&(s.x=this.previousSelection);var r=o.copy(s);r.y=s.y+i*t,this.updateCursor(r,r),l=this.getPositionFromPoint(s.x,r.y)}else l=o.less(n,s)?0>t?n:s:0>t?s:n;this.updateView(this.shiftSelecting?this.from:l,l),this.previousSelection=s.x},removePoint:function(t,e){var i,n,s,l,r=this.getInputValue(!0),h=this.selectionStart(),a=this.selectionEnd();if(o.equal(h,a)?0>t?(i=this.findPoint(h,t,e),h=i,l=this.getContent(h,a),n=l.textContent,s=n.slice(l.selectionStart,l.selectionEnd),r=n.slice(0,l.selectionStart)+r[2]):(i=this.findPoint(h,t,e),a=i,l=this.getContent(h,a),n=l.textContent,s=n.slice(l.selectionStart,l.selectionEnd),r=r[0]+n.slice(l.selectionEnd)):(s=r[1],r=r[0]+r[2],i=h),this.replaceLines(h.line,a.line,r),i=this.getPositionFromChar(i.line,i.ch),this.addHistory({add:"",del:s,textSelected:this.textSelected?a:null,from:h,to:i}),this.focusmode){var c=this.element.content.offsetHeight,d=this.element.content.offsetHeight,u=this.element.view.scrollTop;d!=c&&(this.element.view.scrollTop=u+c-d)}this.updateView(i,i)},goCharLeft:function(){this.moveHorizontalPoint(-1,"char")},goCharRight:function(){this.moveHorizontalPoint(1,"char")},goLineUp:function(){this.moveVerticalPoint(-1,"line")},goLineDown:function(){this.moveVerticalPoint(1,"line")},goLineStart:function(){var t,e=this.selectionStart();t=this.getPositionFromPoint(-this.padding,e.y),this.updateView(this.shiftSelecting?this.from:t,t)},goLineEnd:function(){var t,e=this.selectionStart();t=this.getPositionFromPoint(this.width,e.y),this.updateView(this.shiftSelecting?this.from:t,t)},goLineStartSmart:function(){},goPageUp:function(){},goPageDown:function(){},goDocStart:function(){var t=this.getPositionFromChar(1,0);this.updateView(this.shiftSelecting?this.from:t,t)},goDocEnd:function(){var t,e,i=this.getSize();e=this.getLine(i),t=this.getPositionFromChar(i,e.textContent.length),this.updateView(this.shiftSelecting?this.from:t,t)},goWordLeft:function(){this.moveHorizontalPoint(-1,"word")},goWordRight:function(){this.moveHorizontalPoint(1,"word")},delCharRight:function(){this.removePoint(1,"char")},delCharLeft:function(){this.removePoint(-1,"char")},delWordLeft:function(){this.removePoint(-1,"word")},delWordRight:function(){this.removePoint(1,"word")},deleteLine:function(){},indent:function(t,e,i,n){for(var s=t,l=t,r=this.getLine(e.line),h=i.line-e.line+1,a=[];h--;)a.push(0>t?r.textContent.replace(/^\t/,""):"	"+r.textContent),r=r.nextSibling;0>t&&(s=this.getLine(e.line).textContent===a[0]?0:t,l=this.getLine(i.line).textContent===a[a.length-1]?0:t),this.replaceLines(e.line,i.line,a),o.equal(e,i)?e=i=this.getPositionFromChar(this.from.line,this.from.ch+s):(e=this.getPositionFromChar(this.from.line,this.from.ch+s),i=this.getPositionFromChar(this.to.line,this.to.ch+l)),n||0===s||0===l||this.addHistory({action:"indent",dir:t,from:e,to:i}),this.updateView(e,i)},indentMore:function(){var t=this.selectionStart(),e=this.selectionEnd();this.indent(1,t,e)},indentLess:function(){var t=this.selectionStart(),e=this.selectionEnd();this.indent(-1,t,e)},newlineAndIndent:function(){var t,e,i=this.inputValue.chunk,n=this.selectionStart(),o=this.selectionEnd(),s=n.line+1,l=0,r="\n",h=this.textSelected;if(i.splice(1,1),this.options.smartNewline&&(t=a.newline(i[0]),t[0]&&!this.shiftSelecting)){if(i[0]==t[0]&&!i[1]&&!this.textSelected)return i="",s=n.line,h=t[0],this.replaceLines(s,o.line,i),e=this.getPositionFromChar(s,0),this.addHistory({action:"newline",add:"",del:h,textSelected:null,from:e,to:o}),void this.updateView(e,e);i[1]=t[1]+i[1],l=t[1].length,r+=t[1]}this.replaceLines(n.line,o.line,i),e=this.getPositionFromChar(s,l),this.addHistory({action:"newline",add:r,del:h,textSelected:this.textSelected?o:null,from:n,to:e}),this.focusmode&&(this.element.view.scrollTop=this.element.view.scrollTop+this.line_height),this.updateView(e,e)},add:function(){var t,e=this.getInputValue(),i=this.selectionStart(),n=this.selectionEnd(),o=i.line,s=this.element.input.selectionEnd,r=!1;if(this.textPasted)r=!0,t=e.slice(this.inputValue.chunk[0].length,s),e=e.split(/\r?\n/),o=o+e.length-1,s=e[e.length-1].length-this.inputValue.chunk[2].length;else if(this.options.smartTypingPairs){t=e.slice(i.ch,s);var h=l.smartTypingPairs[t];if(h)return this.smartTyping(i,n,t,h,!1)}else t=e.slice(i.ch,s);this.replaceLines(i.line,n.line,e);var a=this.getPositionFromChar(o,s);if(this.addHistory({add:t,del:this.textSelected,textSelected:this.textSelected?n:null,from:i,to:a}),this.focusmode){var c=this.element.content.offsetHeight,d=this.element.content.offsetHeight,u=this.element.view.scrollTop;d!=c&&(this.element.view.scrollTop=u+c-d)}this.updateView(a,a)},smartTyping:function(t,e,i,n,s,l){if(this.shiftSelecting&&o.equal(t,e)){var r=this.findWord(e);t=r.from,e=r.to}var h=o.copy(t),a=o.copy(e),c=this.getContent(t,e),d=c.chunk[1];c=c.chunk[0]+i+c.chunk[1]+n+c.chunk[2],this.replaceLines(t.line,e.line,c),o.equal(t,e)?t=e=this.getPositionFromChar(t.line,t.ch+i.length):s?(e=this.getPositionFromChar(e.line,e.ch+(o.line(t,e)?i.length:0)),t=this.getPositionFromChar(t.line,t.ch+i.length)):t=e=this.getPositionFromChar(e.line,e.ch+(o.line(t,e)?i.length:0)+n.length),l||this.addHistory({action:"smartTyping",textSelected:d,undo:{from:h,to:a},from:t,to:e,open:i,close:n,select:s}),this.updateView(t,e)},makeStrong:function(){var t=this.selectionStart(),e=this.selectionEnd();this.smartTyping(t,e,"**","**",!1)},makeEmphasis:function(){var t=this.selectionStart(),e=this.selectionEnd();this.smartTyping(t,e,"*","*",!1)},makeDelete:function(){var t=this.selectionStart(),e=this.selectionEnd();this.smartTyping(t,e,"-","-",!1)},selectWordAt:function(t){var e=this.findWord(t);this.updateView(e.from,e.to)},selectLine:function(t){var e=this.getPositionFromPoint(0,t.y),i=this.getPositionFromPoint(this.width+this.padding,t.y);this.updateView(e,i)},undo:function(){var t,e,i,n,o=this.getUndo();if(o){var s=o.action||"";if("indent"==s)this.indent(o.dir<0?1:-1,o.from,o.to,!0);else if("smartTyping"==s){t=o.from,e=o.to,i=this.getContent(t,e);var l=o.open.length+o.close.length,r=o.textSelected.length+l;n=i.textContent.splice(i.selectionStart-(o.textSelected?r:o.open.length),o.textSelected?r:l,o.textSelected),this.replaceLines(t.line,e.line,n),this.updateView(o.undo.from,o.undo.to)}else"todo"==s?this.toggleToDo(o.from,o.to,!0):o.textSelected?(t=o.from,e=o.to,i=this.getContent(t,e),n=i.textContent.splice(i.selectionStart,o.add.length,o.del),this.replaceLines(t.line,e.line,n),this.updateView(t,o.textSelected)):""===o.add?(t=o.from,e=o.to,i=this.getContent(t,t),n=i.textContent.splice(i.selectionStart,"",o.del),this.replaceLines(t.line,t.line,n),this.updateView(e,e)):(t=o.from,e=o.to,i=this.getContent(t,e),n=i.textContent.splice(i.selectionStart,o.add.length,""),this.replaceLines(t.line,e.line,n),this.updateView(t,t))}},redo:function(){var t,e,i,n,o=this.getRedo();if(o){var s=o.action||"";"indent"==s?this.indent(o.dir,o.from,o.to,!0):"smartTyping"==s?this.smartTyping(o.undo.from,o.undo.to,o.open,o.close,o.select,!0):"todo"==s?this.toggleToDo(o.from,o.to,!0):o.textSelected?(t=o.from,e=o.to,i=this.getContent(t,o.textSelected),n=i.textContent.splice(i.selectionStart,o.del.length,o.add),this.replaceLines(t.line,o.textSelected.line,n),this.updateView(e,e)):""===o.add?(t=o.from,e=o.to,i=this.getContent(t,e),n=i.textContent.splice(i.selectionStart,o.del.length,""),this.replaceLines(t.line,e.line,n),this.updateView(t,t)):(t=o.from,e=o.to,i=this.getContent(t,t),n=i.textContent.splice(i.selectionStart,"",o.add),this.replaceLines(t.line,t.line,n),this.updateView(e,e))}},selectAll:function(){var t=this.getSize(),e=this.getLine(t),i=this.getPositionFromChar(1,0),n=this.getPositionFromChar(t,e.textContent.length);this.updateView(i,n)},toggleToDo:function(t,e,i){t=t||this.selectionStart(),e=e||this.selectionEnd();for(var n,o,s,l,r=this.getLine(t.line),h=e.line-t.line+1,a=[];h--;)n=r.textContent,o=n[0],s=n.slice(1),"+"==o||"-"==o?(l=!0,a.push(("+"==o?"-":"+")+s)):a.push(n),r=r.nextSibling;l&&(i||this.addHistory({action:"todo",from:t,to:e}),this.replaceLines(t.line,e.line,a),this.updateInput())},toggleFocusMode:function(){var t=(this.element,this.element.wrapper),e=this.element.view,n=this.line_height;if(this.focusmode){this.focusmode=null,this.onMouseWheel();var o=parseInt(t.style.paddingTop)-n;t.style.padding=n+"px 0",e.scrollTop=this.selectionStart().y-o}else{this.focusmode=!0,this.editor.classList.add("focusmode");var s=Math.floor(e.getBoundingClientRect().height/2/n)*n;t.style.padding=s+"px 0";var l=this.selectionStart();e.scrollTop=l.y;var r=this.onMouseWheel.bind(this),h=i.on(e,"mousewheel",function(){r(),h()},!0);this.getLine(l.line).classList.add("active")}},save:function(){var t=this.options.localStorage;localStorage[t]=this.getText(1,this.getSize())}}),n(s.prototype,{blinkCursor:function(){var t=this.element.cursor.style;t.webkitAnimationName="none",setTimeout(function(){t.webkitAnimationName=""},10)},hideCursor:function(){this.element.cursor.style.display="none"},updateCursor:function(t,e){this.setCursor(e.x,e.y),this.element.cursor.scrollIntoViewIfNeeded(),o.equal(t,e)?this.blinkCursor():this.hideCursor()},setCursor:function(t,e){var i=this.element.cursor.style,n=this.element.input;i.top=e+"px",i.left=t-2+"px",i.display="",n.style.top=e+"px",n.style.left=t+1+"px"}}),n(s.prototype,{focusInput:function(){this.element.input.focus()},blurInput:function(){this.element.input.blur()},updateInput:function(){var t,e=this.selectionStart(),i=this.selectionEnd();this.inputValue=t=this.getContent(e,i),this.element.input.value=t.textContent,this.setInputSelection(t.selectionStart,t.selectionEnd)},setInputSelection:function(t,e){var i=this.element.input;i.selectionStart=t,i.selectionEnd=e,this.textSelected=this.inputValue.chunk[1]},setInputValue:function(t){this.element.cursor.value=t},getInputValue:function(t){var e=this.element.input,i=e.value;return t?[i.slice(0,e.selectionStart),this.textSelected,i.slice(e.selectionEnd)]:i},getInputValueCached:function(){return this.inputValue},setShift:function(t){this.shiftSelecting=t?this.shiftSelecting||this.selectionStart():null},hasInputSelection:function(){try{var t=this.element.input;return t.selectionStart!=t.selectionEnd}catch(e){return!1}}}),n(s.prototype,{selectionStart:function(){return this.inverted?this.to:this.from},selectionEnd:function(){return this.inverted?this.from:this.to},updateSelection:function(t,e,i){this.from=t,this.to=e,this.inverted=!1,o.equal(t,e)?this.inverted=!1:(t.y>e.y||t.y===e.y&&t.x>e.x)&&(this.inverted=!0),i!==!1&&(this.inverted&&(t=this.to,e=this.from),this.setSelection(t,e))},setSelection:function(t,e){var i=this.element,n=i.selectionTop.style,s=i.selectionMiddle.style,l=i.selectionBottom.style,r=this.line_height;if(n.width=s.width=l.width=0,!o.equal(t,e)){if(t.y==e.y)n.top=t.y+"px",n.left=t.x+"px",n.width=Math.abs(e.x-t.x)+"px",n.height=r+"px";else{n.top=t.y+"px",n.left=t.x+"px",n.width=this.width-t.x+this.padding_width+"px",n.height=r+"px";var h=(e.y-t.y)/r;h>1?(s.top=t.y+r+"px",s.left=0,s.width=this.width+this.padding_width+"px",s.height=e.y-t.y-r+"px"):s.width=0,l.top=e.y+"px",l.left=0,l.width=e.x+"px",l.height=r+"px"}this.hideCursor()}}}),s.prototype.parserLines=function(t){"string"==typeof t&&(t=t.split(/\r?\n/)),t=t.slice();for(var e,i,n=document.createDocumentFragment();t.length;)i=t.shift(),e=a.line(i,this.tag_container,this.tab_width,this.em_width),n.appendChild(e);return n};var a={tab:/^(\t+)(.*)/,header:/^(#{1,}\s)(.*)/,blockquote:/^((>\s)+)(.*)/,list:/^([*+-]\s|\d+\.\s)(.*)/,strong:/^(__)(?=\S)([^\0]*?\S)(__)(?!_)|^(\*\*)(?=\S)([^\0]*?\S)(\*\*)(?!\*)/,em:/^(_)(?=\S)([^\0]*?\S)(_)(?!_)|^(\*)(?=\S)([^\0]*?\S)(\*)(?!\*)/,del:/^(-)(?=\S)([^\0]*?\S)(-)(?!-)/,text:/^[^\0]+?(?=[_*-]|$)/,pre:document.createElement("pre"),escape:function(t){return a.pre.textContent=t,a.pre.innerHTML},line:function(t,e,i,n){var o,s,l,r;if(s=document.createElement(e),o=a.tab.exec(t),o&&(s.classList.add("code"),r=o[1].length*i,s.style.marginLeft=r+"px",l='<span class="tab" style="margin-left:-'+r+'px;">'+o[1]+"</span>"+a.inline(o[2])),o=a.header.exec(t),o&&(s.classList.add("header"),r=o[1].length*n,l='<span style="margin-left:-'+r+'px;">'+o[1]+"</span><strong>"+a.inline(o[2])+"</srong>"),o=a.blockquote.exec(t),o&&(s.classList.add("blockquote"),r=o[1].length*n,s.style.marginLeft=r+"px",l='<span style="margin-left:-'+r+'px;">'+o[1]+"</span>"+a.inline(o[3])),o=a.list.exec(t)){s.classList.add("list"),r=o[1].length*n;var h="+ "==o[1]||"- "==o[1]?'<span class="todo">'+o[1][0]+"</span> ":o[1];l="+ "==o[1]?'<span style="margin-left:-'+r+'px;">'+h+"</span><del>"+a.inline(o[2])+"</del>":'<span style="margin-left:-'+r+'px;">'+h+"</span>"+a.inline(o[2])}return s.classList.length||(s.classList.add("paragraph"),l=a.inline(t)),s.innerHTML=l,s},inline:function(t){for(var e,i,n,o=[];t;)e=a.strong.exec(t),e?(n=e[1]||e[4],i=n+"<strong>"+a.escape(e[2]||e[5])+"</strong>"+n,o.push(i),t=t.slice(e[0].length)):(e=a.em.exec(t),e?(n=e[1]||e[4],i=n+"<em>"+a.escape(e[2]||e[5])+"</em>"+n,o.push(i),t=t.slice(e[0].length)):(a.del.exec(t),e?(i="-<del>"+a.escape(e[2])+"</del>-",o.push(i),t=t.slice(e[0].length)):(e=a.text.exec(t),e&&(o.push(a.escape(e[0])),t=t.slice(e[0].length)))));return o.join("")},newline:function(t){var e,i="",n="";if(e=a.tab.exec(t),e&&(i=n=e[1]),e=a.list.exec(t)){i=n=e[1];var o=i.split(".");o.length>1&&(o[0]++,n=o.join("."))}return[i,n]}};n(s.prototype,{addHistory:function(t){this.undomanager.add(t)},getUndo:function(){return this.undomanager.undo()},getRedo:function(){return this.undomanager.redo()}});var c=function(){this.undoStack=[],this.redoStack=[]};c.prototype={add:function(t){var e=this.undoStack.pop()||null;if(e){var i=e.action||t.action||e.textSelected||t.textSelected||t.del&&e.add||t.add&&!e.add||t.add&&!o.equal(e.to,t.from)||t.del&&!o.equal(e.from,t.to);if(i)this.undoStack.push(e),this.undoStack.push(t);else if(e){var n=this.chain(e,t);this.undoStack.push(n)}}else this.undoStack.push(t);this.redoStack=[]},undo:function(){var t=this.undoStack.pop()||null;return t&&this.redoStack.push(t),t},redo:function(){var t=this.redoStack.pop()||null;return t&&this.undoStack.push(t),t},chain:function(t,e){var i={add:t.add+e.add,del:e.del+t.del,textPasted:null};return i.from=i.add?t.from:e.from,i.to=i.add?e.to:t.to,i}},"undefined"!=typeof define&&"function"==typeof define&&define.amd?define("webwriter",[],function(){return s}):window.Editor=s}();